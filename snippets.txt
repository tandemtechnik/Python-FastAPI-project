## get_current_user
async def get_current_user(
    token: Annotated[str, Depends(oauth2_scheme)],
    db: Annotated[AsyncSession, Depends(get_db)],
) -> models.User:
    user_id = verify_access_token(token)
    if user_id is None:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid or expired token",
            headers={"WWW-Authenticate": "Bearer"},
        )

    try:
        user_id_int = int(user_id)
    except (TypeError, ValueError):
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid or expired token",
            headers={"WWW-Authenticate": "Bearer"},
        )

    result = await db.execute(
        select(models.User).where(models.User.id == user_id_int),
    )
    user = result.scalars().first()
    if not user:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="User not found",
            headers={"WWW-Authenticate": "Bearer"},
        )
    return user



## loggedInNav
<div id="loggedInNav" class="d-none">
    <button class="btn btn-outline-light mb-2 mb-md-0 me-md-2"
            type="button"
            data-bs-toggle="modal"
            data-bs-target="#createPostModal">New Post</button>
    <a class="btn btn-light mb-2 mb-md-0 me-md-3"
       href="{{ url_for("account_page") }}"
       id="accountBtn">Account</a>
</div>



## layout_auth_ui_script
<script type="module">
    import { getCurrentUser } from '/static/js/auth.js';

    async function updateAuthUI() {
        const user = await getCurrentUser();
        const loggedInNav = document.getElementById('loggedInNav');
        const loggedOutNav = document.getElementById('loggedOutNav');
        const accountBtn = document.getElementById('accountBtn');

        if (user) {
            loggedInNav.classList.remove('d-none');
            loggedInNav.classList.add('d-flex');
            loggedOutNav.classList.add('d-none');
            accountBtn.textContent = user.username;
        } else {
            loggedInNav.classList.add('d-none');
            loggedInNav.classList.remove('d-flex');
            loggedOutNav.classList.remove('d-none');
            accountBtn.textContent = 'Account';
        }
    }

    updateAuthUI();
</script>



## token_check
const token = getToken();
if (!token) {
    window.location.href = '/login';
    return;
}



## if_401_check
if (response.status === 401) {
    window.location.href = '/login';
    return;
}



## post_scripts_block
{% block scripts %}
<script type="module">
    import { getCurrentUser, getToken } from '/static/js/auth.js';
    import { getErrorMessage, showModal, hideModal } from '/static/js/utils.js';

    const postId = {{ post.id }};
    const postUserId = {{ post.user_id }};

    // Show edit/delete buttons only if current user owns this post
    async function checkOwnership() {
        const user = await getCurrentUser();
        if (user && user.id === postUserId) {
            document.getElementById('postActions').classList.remove('d-none');
        }
    }

    // Edit Post Form Handler
    const editForm = document.getElementById('editPostForm');
    editForm.addEventListener('submit', async (event) => {
        event.preventDefault();

        const token = getToken();
        if (!token) { window.location.href = '/login'; return; }

        const formData = new FormData(editForm);
        const postData = Object.fromEntries(formData.entries());
        delete postData.post_id;

        try {
            const response = await fetch(`/api/posts/${postId}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                },
                body: JSON.stringify(postData),
            });

            if (response.status === 401) { window.location.href = '/login'; return; }
            if (response.status === 403) {
                document.getElementById('errorMessage').textContent =
                    'You are not authorized to edit this post.';
                hideModal('editModal');
                showModal('errorModal');
                return;
            }

            if (response.ok) {
                document.getElementById('successMessage').textContent =
                    'Post updated successfully!';
                hideModal('editModal');
                showModal('successModal');

                document.getElementById('successModal').addEventListener('hidden.bs.modal', () => {
                    window.location.reload();
                }, { once: true });
            } else {
                const error = await response.json();
                document.getElementById('errorMessage').textContent = getErrorMessage(error);
                hideModal('editModal');
                showModal('errorModal');
            }
        } catch (error) {
            document.getElementById('errorMessage').textContent =
                'Network error. Please check your connection and try again.';
            showModal('errorModal');
        }
    });

    // Delete Post Handler
    const deleteButton = document.getElementById('confirmDelete');
    deleteButton.addEventListener('click', async () => {
        const token = getToken();
        if (!token) { window.location.href = '/login'; return; }

        try {
            const response = await fetch(`/api/posts/${postId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` },
            });

            if (response.status === 401) { window.location.href = '/login'; return; }
            if (response.status === 403) {
                document.getElementById('errorMessage').textContent =
                    'You are not authorized to delete this post.';
                hideModal('deleteModal');
                showModal('errorModal');
                return;
            }

            if (response.status === 204) {
                window.location.href = '/';
            } else {
                const error = await response.json();
                document.getElementById('errorMessage').textContent = getErrorMessage(error);
                hideModal('deleteModal');
                showModal('errorModal');
            }
        } catch (error) {
            document.getElementById('errorMessage').textContent =
                'Network error. Please check your connection and try again.';
            showModal('errorModal');
        }
    });

    checkOwnership();
</script>
{% endblock scripts %}
